<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.Editor.HandleInput.FormatFile</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#formatFile"><span class="hs-identifier">formatFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacements"><span class="hs-identifier">applyTextReplacements</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier">TextReplacement</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">List</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntervalMap.Interval</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Interval</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty.Extra</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NEL</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Builder</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TB</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Core.ABT</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ABT</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Decl</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.HashQualified</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HQ</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Lexer.Pos</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pos</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ann</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv.Util</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPE</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPED</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.DeclPrinter</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DeclPrinter</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.TermPrinter</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TermPrinter</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypecheckedUnisonFile</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">UnisonFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Summary</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FileSummary</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Pretty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Range</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- | Format a file, returning a list of Text replacements to apply to the file.</span><span>
</span><span id="line-41"></span><span id="local-6989586621680916379"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#formatFile"><span class="hs-identifier hs-type">formatFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680916379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680916379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PPED.PrettyPrintEnvDecl</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="#local-6989586621680916379"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-type">TextReplacement</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-50"></span><span id="formatFile"><span class="annot"><span class="annottext">formatFile :: forall (m :: * -&gt; *).
Monad m =&gt;
(Maybe (UnisonFile Symbol Ann)
 -&gt; Maybe (TypecheckedUnisonFile Symbol Ann)
 -&gt; m PrettyPrintEnvDecl)
-&gt; Int
-&gt; Absolute
-&gt; Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann)
-&gt; Maybe (Set Range)
-&gt; m (Maybe [TextReplacement])
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#formatFile"><span class="hs-identifier hs-var hs-var">formatFile</span></a></span></span><span> </span><span id="local-6989586621680915750"><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann) -&gt; m PrettyPrintEnvDecl
</span><a href="#local-6989586621680915750"><span class="hs-identifier hs-var">makePPEDForFile</span></a></span></span><span> </span><span id="local-6989586621680915749"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915749"><span class="hs-identifier hs-var">formattingWidth</span></a></span></span><span> </span><span id="local-6989586621680915748"><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621680915748"><span class="hs-identifier hs-var">currentPath</span></a></span></span><span> </span><span id="local-6989586621680915747"><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915747"><span class="hs-identifier hs-var">inputParsedFile</span></a></span></span><span> </span><span id="local-6989586621680915746"><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915746"><span class="hs-identifier hs-var">inputTypecheckedFile</span></a></span></span><span> </span><span id="local-6989586621680915745"><span class="annot"><span class="annottext">Maybe (Set Range)
</span><a href="#local-6989586621680915745"><span class="hs-identifier hs-var">mayRangesToFormat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915743"><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915743"><span class="hs-identifier hs-var">mayParsedFile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915742"><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915742"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann)
-&gt; (Maybe (UnisonFile Symbol Ann),
    Maybe (TypecheckedUnisonFile Symbol Ann))
</span><a href="#local-6989586621680915741"><span class="hs-identifier hs-var">mkUnisonFilesDeterministic</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915747"><span class="hs-identifier hs-var">inputParsedFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915746"><span class="hs-identifier hs-var">inputTypecheckedFile</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621680915740"><span class="annot"><span class="annottext">FileSummary
</span><a href="#local-6989586621680915740"><span class="hs-identifier hs-var">fileSummary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">hoistMaybe</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann) -&gt; Maybe FileSummary
</span><span class="hs-identifier hs-var">FileSummary.mkFileSummary</span></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915743"><span class="hs-identifier hs-var">mayParsedFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915742"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span id="local-6989586621680915737"><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915737"><span class="hs-identifier hs-var">filePPED</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann) -&gt; m PrettyPrintEnvDecl
</span><a href="#local-6989586621680915750"><span class="hs-identifier hs-var">makePPEDForFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915743"><span class="hs-identifier hs-var">mayParsedFile</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915742"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span id="local-6989586621680915735"><span class="annot"><span class="annottext">UnisonFile Symbol Ann
</span><a href="#local-6989586621680915735"><span class="hs-identifier hs-var">parsedFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">hoistMaybe</span></span><span> </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915743"><span class="hs-identifier hs-var">mayParsedFile</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-comment">-- Don't format anything unless the file typechecks.</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-comment">-- The formatter mostly works on a parsed file, but we currently fail to print</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-comment">-- '{{ .. }}'-style docs correctly if they don't typecheck.</span><span>
</span><span id="line-58"></span><span>  </span><span id="local-6989586621680915734"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680915734"><span class="hs-identifier hs-var">_typecheckedFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">hoistMaybe</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915742"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span id="local-6989586621680915733"><span class="annot"><span class="annottext">Map Symbol (Ann, Pretty ColorText)
</span><a href="#local-6989586621680915733"><span class="hs-identifier hs-var">formattedDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSummary
-&gt; Map
     Symbol
     (TypeReferenceId,
      Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann))
</span><span class="hs-identifier hs-var">FileSummary.allTypeDecls</span></span><span> </span><span class="annot"><span class="annottext">FileSummary
</span><a href="#local-6989586621680915740"><span class="hs-identifier hs-var">fileSummary</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-62"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915730"><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915730"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915729"><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680915729"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915728"><span class="annot"><span class="annottext">tldAnn :: Ann
</span><a href="#local-6989586621680915728"><span class="hs-identifier hs-var hs-var">tldAnn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. DataDeclaration v a -&gt; a
</span><span class="hs-identifier hs-var">Decl.annotation</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall v a. EffectDeclaration v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">Decl.toDataDecl</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. DataDeclaration v a -&gt; a
</span><span class="hs-identifier hs-var">Decl.annotation</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680915729"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-64"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915728"><span class="hs-identifier hs-var">tldAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915730"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680915729"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915722"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915722"><span class="hs-identifier hs-var">tldAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Bool
</span><a href="#local-6989586621680915721"><span class="hs-identifier hs-var">isInFormatRange</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915722"><span class="hs-identifier hs-var">tldAnn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(TraversableWithIndex i t, Applicative f) =&gt;
(i -&gt; a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">itraverse</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680915719"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915719"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915718"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915718"><span class="hs-identifier hs-var">tldAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915717"><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915717"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915716"><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680915716"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-68"></span><span>        </span><span id="local-6989586621680915715"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915715"><span class="hs-identifier hs-var">symName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">hoistMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v. Var v =&gt; v -&gt; Maybe Name
</span><span class="hs-identifier hs-var">Name.parseVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915719"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915713"><span class="annot"><span class="annottext">declNameSegments :: NonEmpty NameSegment
</span><a href="#local-6989586621680915713"><span class="hs-identifier hs-var hs-var">declNameSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; NonEmpty a -&gt; NonEmpty a
</span><span class="hs-identifier hs-var">NEL.appendr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><span class="hs-identifier hs-var">Path.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621680915748"><span class="hs-identifier hs-var">currentPath</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">Name.segments</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915715"><span class="hs-identifier hs-var">symName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915708"><span class="annot"><span class="annottext">declName :: Name
</span><a href="#local-6989586621680915708"><span class="hs-identifier hs-var hs-var">declName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromSegments</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680915713"><span class="hs-identifier hs-var">declNameSegments</span></a></span><span>
</span><span id="line-71"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915706"><span class="annot"><span class="annottext">hqName :: HashQualified Name
</span><a href="#local-6989586621680915706"><span class="hs-identifier hs-var hs-var">hqName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. n -&gt; HashQualified n
</span><span class="hs-identifier hs-var">HQ.fromName</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915715"><span class="hs-identifier hs-var">symName</span></a></span><span>
</span><span id="line-72"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915704"><span class="annot"><span class="annottext">biasedPPED :: PrettyPrintEnvDecl
</span><a href="#local-6989586621680915704"><span class="hs-identifier hs-var hs-var">biasedPPED</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; PrettyPrintEnvDecl -&gt; PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.biasTo</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915708"><span class="hs-identifier hs-var">declName</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915737"><span class="hs-identifier hs-var">filePPED</span></a></span><span>
</span><span id="line-73"></span><span>        </span><span class="hs-comment">-- If it's a unique type the parser will re-order constructors arbitrarily because</span><span>
</span><span id="line-74"></span><span>        </span><span class="hs-comment">-- the random unique seed gets mixed in and then things are ordered by hash.</span><span>
</span><span id="line-75"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-comment">-- The constructor order will always be re-ordered on definition Add anyways, so we</span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-comment">-- just force alphabetical order for unique types for sanity reasons.</span><span>
</span><span id="line-78"></span><span>        </span><span class="hs-comment">-- Doesn't work unless we alter it before building the pped</span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-comment">-- let deterministicDecl = decl &amp; Decl.declAsDataDecl_ . Decl.constructors_ %~ sortOn (view _1)</span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-81"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915718"><span class="hs-identifier hs-var">tldAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall v a.
Var v =&gt;
PrettyPrintEnvDecl
-&gt; TypeReference
-&gt; HashQualified Name
-&gt; Decl v a
-&gt; Pretty SyntaxText
</span><span class="hs-identifier hs-var">DeclPrinter.prettyDecl</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915704"><span class="hs-identifier hs-var">biasedPPED</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall h t. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.DerivedId</span></span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915717"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashQualified Name
</span><a href="#local-6989586621680915706"><span class="hs-identifier hs-var">hqName</span></a></span><span> </span><span class="annot"><span class="annottext">Either (EffectDeclaration Symbol Ann) (DataDeclaration Symbol Ann)
</span><a href="#local-6989586621680915716"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>            </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">forall r. Pretty (SyntaxText' r) -&gt; Pretty ColorText
</span><span class="hs-identifier hs-var">Pretty.syntaxToColor</span></span><span>
</span><span id="line-83"></span><span>  </span><span id="local-6989586621680915697"><span class="annot"><span class="annottext">Map Symbol (Ann, Pretty ColorText)
</span><a href="#local-6989586621680915697"><span class="hs-identifier hs-var">formattedTerms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSummary
-&gt; Map
     Symbol
     (Ann, Maybe TypeReferenceId, Term Symbol Ann,
      Maybe (Type Symbol Ann))
</span><span class="hs-identifier hs-var">FileSummary.termsBySymbol</span></span><span> </span><span class="annot"><span class="annottext">FileSummary
</span><a href="#local-6989586621680915740"><span class="hs-identifier hs-var">fileSummary</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915695"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915695"><span class="hs-identifier hs-var">tldAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReferenceId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915694"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915694"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Term Symbol Ann -&gt; Bool
</span><a href="#local-6989586621680915693"><span class="hs-identifier hs-var">shouldFormatTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915695"><span class="hs-identifier hs-var">tldAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915694"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>      </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(TraversableWithIndex i t, Applicative f) =&gt;
(i -&gt; a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">itraverse</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680915692"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915692"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915691"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915691"><span class="hs-identifier hs-var">tldAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915690"><span class="annot"><span class="annottext">Maybe TypeReferenceId
</span><a href="#local-6989586621680915690"><span class="hs-identifier hs-var">mayRefId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915689"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915689"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915688"><span class="annot"><span class="annottext">Maybe (Type Symbol Ann)
</span><a href="#local-6989586621680915688"><span class="hs-identifier hs-var">_typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>        </span><span id="local-6989586621680915687"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915687"><span class="hs-identifier hs-var">symName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Maybe a -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">hoistMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v. Var v =&gt; v -&gt; Maybe Name
</span><span class="hs-identifier hs-var">Name.parseVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915692"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915686"><span class="annot"><span class="annottext">defNameSegments :: NonEmpty NameSegment
</span><a href="#local-6989586621680915686"><span class="hs-identifier hs-var hs-var">defNameSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; NonEmpty a -&gt; NonEmpty a
</span><span class="hs-identifier hs-var">NEL.appendr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><span class="hs-identifier hs-var">Path.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Absolute -&gt; Path
</span><span class="hs-identifier hs-var">Path.unabsolute</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><a href="#local-6989586621680915748"><span class="hs-identifier hs-var">currentPath</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">Name.segments</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915687"><span class="hs-identifier hs-var">symName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915685"><span class="annot"><span class="annottext">defName :: Name
</span><a href="#local-6989586621680915685"><span class="hs-identifier hs-var hs-var">defName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromSegments</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680915686"><span class="hs-identifier hs-var">defNameSegments</span></a></span><span>
</span><span id="line-90"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915684"><span class="annot"><span class="annottext">hqName :: HashQualified Name
</span><a href="#local-6989586621680915684"><span class="hs-identifier hs-var hs-var">hqName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. n -&gt; HashQualified n
</span><span class="hs-identifier hs-var">HQ.NameOnly</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915687"><span class="hs-identifier hs-var">symName</span></a></span><span>
</span><span id="line-91"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915682"><span class="annot"><span class="annottext">biasedPPED :: PrettyPrintEnvDecl
</span><a href="#local-6989586621680915682"><span class="hs-identifier hs-var hs-var">biasedPPED</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; PrettyPrintEnvDecl -&gt; PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.biasTo</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680915685"><span class="hs-identifier hs-var">defName</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915737"><span class="hs-identifier hs-var">filePPED</span></a></span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915681"><span class="annot"><span class="annottext">definitionPPE :: PrettyPrintEnv
</span><a href="#local-6989586621680915681"><span class="hs-identifier hs-var hs-var">definitionPPE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe TypeReferenceId
</span><a href="#local-6989586621680915690"><span class="hs-identifier hs-var">mayRefId</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-93"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680915680"><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915680"><span class="hs-identifier hs-var">refId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; TypeReference -&gt; PrettyPrintEnv
</span><span class="hs-identifier hs-var">PPE.declarationPPE</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915682"><span class="hs-identifier hs-var">biasedPPED</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall h t. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.DerivedId</span></span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621680915680"><span class="hs-identifier hs-var">refId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>              </span><span class="annot"><span class="annottext">Maybe TypeReferenceId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; PrettyPrintEnv
</span><span class="hs-identifier hs-var">PPED.suffixifiedPPE</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680915682"><span class="hs-identifier hs-var">biasedPPED</span></a></span><span>
</span><span id="line-95"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915677"><span class="annot"><span class="annottext">formattedTerm :: Pretty ColorText
</span><a href="#local-6989586621680915677"><span class="hs-identifier hs-var hs-var">formattedTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r. Pretty (SyntaxText' r) -&gt; Pretty ColorText
</span><span class="hs-identifier hs-var">Pretty.syntaxToColor</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall v at ap a.
Var v =&gt;
PrettyPrintEnv
-&gt; HashQualified Name -&gt; Term2 v at ap v a -&gt; Pretty SyntaxText
</span><span class="hs-identifier hs-var">TermPrinter.prettyBinding</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621680915681"><span class="hs-identifier hs-var">definitionPPE</span></a></span><span> </span><span class="annot"><span class="annottext">HashQualified Name
</span><a href="#local-6989586621680915684"><span class="hs-identifier hs-var">hqName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
UnisonFile Symbol a -&gt; Symbol -&gt; Term Symbol a -&gt; Term Symbol a
</span><a href="#local-6989586621680915675"><span class="hs-identifier hs-var">removeGeneratedTypeAnnotations</span></a></span><span> </span><span class="annot"><span class="annottext">UnisonFile Symbol Ann
</span><a href="#local-6989586621680915735"><span class="hs-identifier hs-var">parsedFile</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915692"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915689"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-comment">-- TODO: format watch expressions and test watches</span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-comment">-- let formattedWatches =</span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-comment">--       allWatches fileSummary &amp; map \(_tldAnn, maySym, _mayRef, trm, _mayType, mayWatchKind) -&gt; do</span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-comment">--         case (mayWatchKind, maySym) of</span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-comment">--           (Just wk, Just (Symbol.Symbol _ (Var.User {}))) -&gt;</span><span>
</span><span id="line-101"></span><span>        </span><span class="hs-comment">--             -- Watch with binding</span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-comment">--             Pretty.syntaxToColor $ Pretty.string wk &lt;&gt; &quot;&gt; &quot; &lt;&gt; TermPrinter.prettyBindingWithoutTypeSignature definitionPPE hqName (stripTypeAnnotation trm)</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-comment">--           (Just wk, _) -&gt; Pretty.string wk &lt;&gt; &quot;&gt; &quot; &lt;&gt; TermPrinter.prettyBlock False definitionPPE (stripTypeAnnotation trm)</span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-comment">--           (Nothing, _) -&gt; &quot;&gt; &quot; &lt;&gt; TermPrinter.prettyBlock False definitionPPE (stripTypeAnnotation trm)</span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915691"><span class="hs-identifier hs-var">tldAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680915677"><span class="hs-identifier hs-var">formattedTerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-comment">-- Only keep definitions which are _actually_ in the file, skipping generated accessors</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-comment">-- and such.</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915674"><span class="annot"><span class="annottext">nonGeneratedDefs :: Map Symbol ((Pos, Pos), Pretty ColorText)
</span><a href="#local-6989586621680915674"><span class="hs-identifier hs-var hs-var">nonGeneratedDefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Symbol (Ann, Pretty ColorText)
</span><a href="#local-6989586621680915697"><span class="hs-identifier hs-var">formattedTerms</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map Symbol (Ann, Pretty ColorText)
</span><a href="#local-6989586621680915733"><span class="hs-identifier hs-var">formattedDecls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>          </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span>
</span><span id="line-112"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-113"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680915671"><span class="annot"><span class="annottext">Pos
$sel:start:Intrinsic :: Ann -&gt; Pos
start :: Pos
</span><span class="hs-identifier hs-var hs-var">start</span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915669"><span class="annot"><span class="annottext">Pos
$sel:end:Intrinsic :: Ann -&gt; Pos
end :: Pos
</span><span class="hs-identifier hs-var hs-var">end</span></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915667"><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680915667"><span class="hs-identifier hs-var">txt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915671"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915669"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680915667"><span class="hs-identifier hs-var">txt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>                </span><span class="annot"><span class="annottext">(Ann, Pretty ColorText)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-115"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-comment">-- when (null filteredDefs) empty {- Don't format if we have no definitions or it wipes out the fold! -}</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915666"><span class="annot"><span class="annottext">textEdits :: [TextReplacement]
</span><a href="#local-6989586621680915666"><span class="hs-identifier hs-var hs-var">textEdits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><span class="annottext">Map Symbol ((Pos, Pos), Pretty ColorText)
</span><a href="#local-6989586621680915674"><span class="hs-identifier hs-var">nonGeneratedDefs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621680915664"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915664"><span class="hs-identifier hs-var">start</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915663"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915663"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915662"><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680915662"><span class="hs-identifier hs-var">txt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>          </span><span id="local-6989586621680915661"><span class="annot"><span class="annottext">Range
</span><a href="#local-6989586621680915661"><span class="hs-identifier hs-var">range</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Maybe Range
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToRange"><span class="hs-identifier hs-var">annToRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Pos -&gt; Ann
</span><span class="hs-identifier hs-var">Ann.Ann</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915664"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915663"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>          </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Range -&gt; TextReplacement
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-var">TextReplacement</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Width -&gt; Pretty ColorText -&gt; String
</span><span class="hs-identifier hs-var">Pretty.toPlain</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Width
</span><span class="hs-identifier hs-var">Pretty.Width</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915749"><span class="hs-identifier hs-var">formattingWidth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680915662"><span class="hs-identifier hs-var">txt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Range
</span><a href="#local-6989586621680915661"><span class="hs-identifier hs-var">range</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[TextReplacement]
</span><a href="#local-6989586621680915666"><span class="hs-identifier hs-var">textEdits</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="#local-6989586621680915721"><span class="hs-identifier hs-type">isInFormatRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621680915721"><span class="annot"><span class="annottext">isInFormatRange :: Ann -&gt; Bool
</span><a href="#local-6989586621680915721"><span class="hs-identifier hs-var hs-var">isInFormatRange</span></a></span></span><span> </span><span id="local-6989586621680915654"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915654"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Set Range)
</span><a href="#local-6989586621680915745"><span class="hs-identifier hs-var">mayRangesToFormat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Set Range)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680915653"><span class="annot"><span class="annottext">Set Range
</span><a href="#local-6989586621680915653"><span class="hs-identifier hs-var">rangesToFormat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann -&gt; Range -&gt; Bool
</span><a href="#local-6989586621680915651"><span class="hs-identifier hs-var">annRangeOverlap</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915654"><span class="hs-identifier hs-var">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Range
</span><a href="#local-6989586621680915653"><span class="hs-identifier hs-var">rangesToFormat</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><a href="#local-6989586621680915693"><span class="hs-identifier hs-type">shouldFormatTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621680915693"><span class="annot"><span class="annottext">shouldFormatTerm :: Ann -&gt; Term Symbol Ann -&gt; Bool
</span><a href="#local-6989586621680915693"><span class="hs-identifier hs-var hs-var">shouldFormatTerm</span></a></span></span><span> </span><span id="local-6989586621680915650"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915650"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621680915649"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915649"><span class="hs-identifier hs-var">trm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="annottext">Ann -&gt; Bool
</span><a href="#local-6989586621680915721"><span class="hs-identifier hs-var">isInFormatRange</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915650"><span class="hs-identifier hs-var">ann</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Bool
</span><a href="#local-6989586621680915646"><span class="hs-identifier hs-var">isUntypecheckedDoc</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915649"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-comment">-- The lexer converts '{{ .. }}' into 'syntax.docUntitledSection (..)', but the pretty</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-comment">-- printer doesn't print it back as '{{ .. }}' unless it typechecks, so</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- we just don't format docs that have un-resolved 'docUntitledSection' symbols.</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><a href="#local-6989586621680915646"><span class="hs-identifier hs-type">isUntypecheckedDoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-137"></span><span>    </span><span id="local-6989586621680915646"><span class="annot"><span class="annottext">isUntypecheckedDoc :: Term Symbol Ann -&gt; Bool
</span><a href="#local-6989586621680915646"><span class="hs-identifier hs-var hs-var">isUntypecheckedDoc</span></a></span></span><span> </span><span id="local-6989586621680915645"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915645"><span class="hs-identifier hs-var">trm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) v a. Term f v a -&gt; Set v
</span><span class="hs-identifier hs-var">ABT.freeVars</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680915645"><span class="hs-identifier hs-var">trm</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">forall v. Var v =&gt; v -&gt; String
</span><span class="hs-identifier hs-var">Var.nameStr</span></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;syntax.docUntitledSection&quot;</span></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- Does the given range overlap with the given annotation?</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="#local-6989586621680915651"><span class="hs-identifier hs-type">annRangeOverlap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621680915651"><span class="annot"><span class="annottext">annRangeOverlap :: Ann -&gt; Range -&gt; Bool
</span><a href="#local-6989586621680915651"><span class="hs-identifier hs-var hs-var">annRangeOverlap</span></a></span></span><span> </span><span id="local-6989586621680915640"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915640"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680915639"><span class="annot"><span class="annottext">Range
</span><a href="#local-6989586621680915639"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="annottext">Ann -&gt; Maybe (Interval Pos)
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToInterval"><span class="hs-identifier hs-var">annToInterval</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915640"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Interval Pos)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680915637"><span class="annot"><span class="annottext">Interval Pos
</span><a href="#local-6989586621680915637"><span class="hs-identifier hs-var">annI</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Range -&gt; Interval Pos
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#rangeToInterval"><span class="hs-identifier hs-var">rangeToInterval</span></a></span><span> </span><span class="annot"><span class="annottext">Range
</span><a href="#local-6989586621680915639"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Interval a -&gt; Interval a -&gt; Bool
</span><span class="hs-operator hs-var">`Interval.overlaps`</span></span><span> </span><span class="annot"><span class="annottext">Interval Pos
</span><a href="#local-6989586621680915637"><span class="hs-identifier hs-var">annI</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- Typechecking ALWAYS adds a type-signature, but we don't want to add ones that didn't</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-comment">-- already exist in the source file.</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621680916161"><span class="annot"><a href="#local-6989586621680915675"><span class="hs-identifier hs-type">removeGeneratedTypeAnnotations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621680916161"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621680916161"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621680916161"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621680915675"><span class="annot"><span class="annottext">removeGeneratedTypeAnnotations :: forall a.
UnisonFile Symbol a -&gt; Symbol -&gt; Term Symbol a -&gt; Term Symbol a
</span><a href="#local-6989586621680915675"><span class="hs-identifier hs-var hs-var">removeGeneratedTypeAnnotations</span></a></span></span><span> </span><span id="local-6989586621680915632"><span class="annot"><span class="annottext">UnisonFile Symbol a
</span><a href="#local-6989586621680915632"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span id="local-6989586621680915631"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915631"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Term.Ann'</span></span><span> </span><span id="local-6989586621680915629"><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680915629"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621680915628"><span class="annot"><span class="annottext">Type Symbol a
</span><a href="#local-6989586621680915628"><span class="hs-identifier hs-var">_annotation</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. Eq v =&gt; UnisonFile v a -&gt; v -&gt; Bool
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#hasUserTypeSignature"><span class="hs-identifier hs-var">hasUserTypeSignature</span></a></span><span> </span><span class="annot"><span class="annottext">UnisonFile Symbol a
</span><a href="#local-6989586621680915632"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680915631"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680915629"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span id="local-6989586621680915626"><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680915626"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term Symbol a
</span><a href="#local-6989586621680915626"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-comment">-- This is a bit of a hack.</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- The file parser uses a different unique ID for unique types on every parse,</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-comment">-- that id changes hashes, and constructors are ordered by that hash.</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-comment">-- This means that pretty-printing isn't deterministic and constructors will re-order</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- themselves on every save :|</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- It's difficult and a bad idea to change the parser to use a deterministic unique ID,</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- so instead we just re-sort the constructors by their source-file annotation AFTER</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">-- parsing. This is fine for pretty-printing, but don't use this for anything other than</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- formatting since the Decls it produces aren't technically valid.</span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><a href="#local-6989586621680915741"><span class="hs-identifier hs-type">mkUnisonFilesDeterministic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621680915741"><span class="annot"><span class="annottext">mkUnisonFilesDeterministic :: Maybe (UnisonFile Symbol Ann)
-&gt; Maybe (TypecheckedUnisonFile Symbol Ann)
-&gt; (Maybe (UnisonFile Symbol Ann),
    Maybe (TypecheckedUnisonFile Symbol Ann))
</span><a href="#local-6989586621680915741"><span class="hs-identifier hs-var hs-var">mkUnisonFilesDeterministic</span></a></span></span><span> </span><span id="local-6989586621680915625"><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915625"><span class="hs-identifier hs-var">mayUnisonFile</span></a></span></span><span> </span><span id="local-6989586621680915624"><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915624"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915623"><span class="annot"><span class="annottext">sortedUF :: Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915623"><span class="hs-identifier hs-var hs-var">sortedUF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915625"><span class="hs-identifier hs-var">mayUnisonFile</span></a></span><span>
</span><span id="line-170"></span><span>              </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;dataDeclarationsId&quot; a =&gt; a
</span><span class="">#dataDeclarationsId</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">forall v. DataDeclaration v Ann -&gt; DataDeclaration v Ann
</span><a href="#local-6989586621680915619"><span class="hs-identifier hs-var">sortConstructors</span></a></span><span>
</span><span id="line-171"></span><span>              </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;effectDeclarationsId&quot; a =&gt; a
</span><span class="">#effectDeclarationsId</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall v a. Iso' (EffectDeclaration v a) (DataDeclaration v a)
</span><span class="hs-identifier hs-var">Decl.asDataDecl_</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">forall v. DataDeclaration v Ann -&gt; DataDeclaration v Ann
</span><a href="#local-6989586621680915619"><span class="hs-identifier hs-var">sortConstructors</span></a></span><span>
</span><span id="line-172"></span><span>          </span><span id="local-6989586621680915617"><span class="annot"><span class="annottext">sortedTF :: Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915617"><span class="hs-identifier hs-var hs-var">sortedTF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>            </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915624"><span class="hs-identifier hs-var">mayTypecheckedFile</span></a></span><span>
</span><span id="line-174"></span><span>              </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;dataDeclarationsId'&quot; a =&gt; a
</span><span class="">#dataDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">forall v. DataDeclaration v Ann -&gt; DataDeclaration v Ann
</span><a href="#local-6989586621680915619"><span class="hs-identifier hs-var">sortConstructors</span></a></span><span>
</span><span id="line-175"></span><span>              </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Prism (Maybe a) (Maybe b) a b
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;effectDeclarationsId'&quot; a =&gt; a
</span><span class="">#effectDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall v a. Iso' (EffectDeclaration v a) (DataDeclaration v a)
</span><span class="hs-identifier hs-var">Decl.asDataDecl_</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">forall v. DataDeclaration v Ann -&gt; DataDeclaration v Ann
</span><a href="#local-6989586621680915619"><span class="hs-identifier hs-var">sortConstructors</span></a></span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (UnisonFile Symbol Ann)
</span><a href="#local-6989586621680915623"><span class="hs-identifier hs-var">sortedUF</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (TypecheckedUnisonFile Symbol Ann)
</span><a href="#local-6989586621680915617"><span class="hs-identifier hs-var">sortedTF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">-- ppedForFileHelper</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621680916127"><span class="annot"><a href="#local-6989586621680915619"><span class="hs-identifier hs-type">sortConstructors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decl.DataDeclaration</span></span><span> </span><span class="annot"><a href="#local-6989586621680916127"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decl.DataDeclaration</span></span><span> </span><span class="annot"><a href="#local-6989586621680916127"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span></span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621680915619"><span class="annot"><span class="annottext">sortConstructors :: forall v. DataDeclaration v Ann -&gt; DataDeclaration v Ann
</span><a href="#local-6989586621680915619"><span class="hs-identifier hs-var hs-var">sortConstructors</span></a></span></span><span> </span><span id="local-6989586621680915607"><span class="annot"><span class="annottext">DataDeclaration v Ann
</span><a href="#local-6989586621680915607"><span class="hs-identifier hs-var">dd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-comment">-- Sort by their Ann so we keep the order they were in the original file.</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">DataDeclaration v Ann
</span><a href="#local-6989586621680915607"><span class="hs-identifier hs-var">dd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall v a. Lens' (DataDeclaration v a) [(a, v, Type v a)]
</span><span class="hs-identifier hs-var">Decl.constructors_</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_1</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToRange"><span class="hs-identifier hs-type">annToRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span>
</span><span id="line-185"></span><span id="annToRange"><span class="annot"><span class="annottext">annToRange :: Ann -&gt; Maybe Range
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToRange"><span class="hs-identifier hs-var hs-var">annToRange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier hs-var">Ann.Intrinsic</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier hs-var">Ann.External</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ann.GeneratedFrom</span></span><span> </span><span id="local-6989586621680915599"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915599"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Maybe Range
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToRange"><span class="hs-identifier hs-var">annToRange</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915599"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span id="local-6989586621680915598"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915598"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621680915597"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915597"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pos -&gt; Range
</span><span class="hs-identifier hs-var">Range</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915598"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915597"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#rangeToInterval"><span class="hs-identifier hs-type">rangeToInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Interval.Interval</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos.Pos</span></span><span>
</span><span id="line-192"></span><span id="rangeToInterval"><span class="annot"><span class="annottext">rangeToInterval :: Range -&gt; Interval Pos
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#rangeToInterval"><span class="hs-identifier hs-var hs-var">rangeToInterval</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span> </span><span id="local-6989586621680915595"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915595"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621680915594"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915594"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">forall a. a -&gt; a -&gt; Interval a
</span><span class="hs-identifier hs-var">Interval.ClosedInterval</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915595"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680915594"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToInterval"><span class="hs-identifier hs-type">annToInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann.Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Interval.Interval</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pos.Pos</span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span id="annToInterval"><span class="annot"><span class="annottext">annToInterval :: Ann -&gt; Maybe (Interval Pos)
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToInterval"><span class="hs-identifier hs-var hs-var">annToInterval</span></a></span></span><span> </span><span id="local-6989586621680915592"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915592"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ann -&gt; Maybe Range
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#annToRange"><span class="hs-identifier hs-var">annToRange</span></a></span><span> </span><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680915592"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Range -&gt; Interval Pos
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#rangeToInterval"><span class="hs-identifier hs-var">rangeToInterval</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Returns 'True' if the given symbol is a term with a user provided type signature in the</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- parsed file, false otherwise.</span><span>
</span><span id="line-200"></span><span id="local-6989586621680916136"><span id="local-6989586621680916137"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#hasUserTypeSignature"><span class="hs-identifier hs-type">hasUserTypeSignature</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621680916137"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UnisonFile</span></span><span> </span><span class="annot"><a href="#local-6989586621680916137"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680916136"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680916137"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-201"></span><span id="hasUserTypeSignature"><span class="annot"><span class="annottext">hasUserTypeSignature :: forall v a. Eq v =&gt; UnisonFile v a -&gt; v -&gt; Bool
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#hasUserTypeSignature"><span class="hs-identifier hs-var hs-var">hasUserTypeSignature</span></a></span></span><span> </span><span id="local-6989586621680915587"><span class="annot"><span class="annottext">UnisonFile v a
</span><a href="#local-6989586621680915587"><span class="hs-identifier hs-var">parsedFile</span></a></span></span><span> </span><span id="local-6989586621680915586"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680915586"><span class="hs-identifier hs-var">sym</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. UnisonFile v a -&gt; Map v (a, Term v a)
</span><span class="hs-identifier hs-var">UF.terms</span></span><span> </span><span class="annot"><span class="annottext">UnisonFile v a
</span><a href="#local-6989586621680915587"><span class="hs-identifier hs-var">parsedFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915583"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680915583"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915582"><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680915582"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680915583"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680915586"><span class="hs-identifier hs-var">sym</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. Term v a -&gt; Maybe (Type v a)
</span><span class="hs-identifier hs-var">Term.getTypeAnnotation</span></span><span> </span><span class="annot"><span class="annottext">Term v a
</span><a href="#local-6989586621680915582"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-comment">-- | A text replacement to apply to a file.</span><span>
</span><span id="line-206"></span><span class="hs-keyword">data</span><span> </span><span id="TextReplacement"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-var">TextReplacement</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TextReplacement"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-var">TextReplacement</span></a></span></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The new new text to replace the old text in the range with. w</span><span>
</span><span id="line-208"></span><span>    </span><span id="%24sel%3AreplacementText%3ATextReplacement"><span class="annot"><span class="annottext">TextReplacement -&gt; Text
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#%24sel%3AreplacementText%3ATextReplacement"><span class="hs-identifier hs-var hs-var">replacementText</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- The range to replace, [start, end)</span><span>
</span><span id="line-210"></span><span>    </span><span id="%24sel%3AreplacementRange%3ATextReplacement"><span class="annot"><span class="annottext">TextReplacement -&gt; Range
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#%24sel%3AreplacementRange%3ATextReplacement"><span class="hs-identifier hs-var hs-var">replacementRange</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915570"><span id="local-6989586621680915576"><span class="annot"><span class="annottext">TextReplacement -&gt; TextReplacement -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: TextReplacement -&gt; TextReplacement -&gt; Bool
$c/= :: TextReplacement -&gt; TextReplacement -&gt; Bool
== :: TextReplacement -&gt; TextReplacement -&gt; Bool
$c== :: TextReplacement -&gt; TextReplacement -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915557"><span id="local-6989586621680915559"><span id="local-6989586621680915567"><span class="annot"><span class="annottext">Int -&gt; TextReplacement -&gt; ShowS
[TextReplacement] -&gt; ShowS
TextReplacement -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TextReplacement] -&gt; ShowS
$cshowList :: [TextReplacement] -&gt; ShowS
show :: TextReplacement -&gt; String
$cshow :: TextReplacement -&gt; String
showsPrec :: Int -&gt; TextReplacement -&gt; ShowS
$cshowsPrec :: Int -&gt; TextReplacement -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">-- | Apply a list of range replacements to a text, returning the updated text.</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- &gt;&gt;&gt; applyFormatUpdates [TextReplacement &quot;cakes&quot; (Range (Pos.Pos 1 21) (Pos.Pos 1 28))] &quot;my favorite food is oranges because\nthey are delicious and nutritious&quot;</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- &quot;my favorite food is cakes because\nthey are delicious and nutritious&quot;</span><span>
</span><span id="line-218"></span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- Multiple replacements.</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- &gt;&gt;&gt; let txt = &quot;my favorite food is oranges because\nthey are delicious and nutritious&quot;</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- &gt;&gt;&gt; let replacements = [TextReplacement &quot;cakes&quot; (Range (Pos.Pos 1 21) (Pos.Pos 1 28)), TextReplacement &quot;decadent&quot; (Range (Pos.Pos 2 10) (Pos.Pos 2 19)), TextReplacement &quot;tasty&quot; (Range (Pos.Pos 2 24) (Pos.Pos 2 34))]</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- &gt;&gt;&gt; applyFormatUpdates replacements txt</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- &quot;my favorite food is cakes because\nthey are decadent and tasty&quot;</span><span>
</span><span id="line-224"></span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- Multi-line replacements.</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- &gt;&gt;&gt; let txt = &quot;mary had a little lamb\nwhose fleece was white as snow\nand everywhere that mary went\nthe lamb was sure to go&quot;</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- &gt;&gt;&gt; let replacements = [TextReplacement &quot;lambo, which&quot; (Range (Pos.Pos 1 19) (Pos.Pos 2 13)), TextReplacement &quot; the people stared&quot; (Range (Pos.Pos 3 99) (Pos.Pos 4 99))]</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- &gt;&gt;&gt; applyFormatUpdates replacements txt</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- &quot;mary had a little lambo, which was white as snow\nand everywhere that mary went the people stared&quot;</span><span>
</span><span id="line-230"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacements"><span class="hs-identifier hs-type">applyTextReplacements</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-type">TextReplacement</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-231"></span><span id="applyTextReplacements"><span class="annot"><span class="annottext">applyTextReplacements :: [TextReplacement] -&gt; Text -&gt; Text
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacements"><span class="hs-identifier hs-var hs-var">applyTextReplacements</span></a></span></span><span> </span><span id="local-6989586621680915555"><span class="annot"><span class="annottext">[TextReplacement]
</span><a href="#local-6989586621680915555"><span class="hs-identifier hs-var">replacements</span></a></span></span><span> </span><span id="local-6989586621680915554"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915554"><span class="hs-identifier hs-var">inputText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)] -&gt; [Text] -&gt; Builder
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915552"><span class="hs-identifier hs-var">relativeOffsets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; [Text]
</span><span class="hs-identifier hs-var">Text.lines</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915554"><span class="hs-identifier hs-var">inputText</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Text
</span><span class="hs-identifier hs-var">TB.run</span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><a href="#local-6989586621680915549"><span class="hs-identifier hs-type">tupleReplacements</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621680915549"><span class="annot"><span class="annottext">tupleReplacements :: [(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915549"><span class="hs-identifier hs-var hs-var">tupleReplacements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">[TextReplacement]
</span><a href="#local-6989586621680915555"><span class="hs-identifier hs-var">replacements</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span>
</span><span id="line-237"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#TextReplacement"><span class="hs-identifier hs-type">TextReplacement</span></a></span><span> </span><span id="local-6989586621680915548"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915548"><span class="hs-identifier hs-var">txt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pos.Pos</span></span><span> </span><span id="local-6989586621680915546"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915546"><span class="hs-identifier hs-var">startLine</span></a></span></span><span> </span><span id="local-6989586621680915545"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915545"><span class="hs-identifier hs-var">startCol</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pos.Pos</span></span><span> </span><span id="local-6989586621680915544"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915544"><span class="hs-identifier hs-var">endLine</span></a></span></span><span> </span><span id="local-6989586621680915543"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915543"><span class="hs-identifier hs-var">endCol</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>              </span><span class="hs-comment">-- Convert from 1-based indexing to 0-based indexing</span><span>
</span><span id="line-239"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915546"><span class="hs-identifier hs-var">startLine</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915545"><span class="hs-identifier hs-var">startCol</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915544"><span class="hs-identifier hs-var">endLine</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915543"><span class="hs-identifier hs-var">endCol</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915548"><span class="hs-identifier hs-var">txt</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-240"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621680915552"><span class="annot"><span class="annottext">relativeOffsets :: [(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915552"><span class="hs-identifier hs-var hs-var">relativeOffsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)] -&gt; [(Int, Int, Maybe Text)]
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#relativizeOffsets"><span class="hs-identifier hs-var">relativizeOffsets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">List.sortOn</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915537"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915537"><span class="hs-identifier hs-var">line</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915536"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915536"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915537"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915536"><span class="hs-identifier hs-var">col</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915549"><span class="hs-identifier hs-var">tupleReplacements</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- | Given a list of offsets, return a list of offsets where each offset is positioned relative to the previous offset.</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- I.e. if the first offset is at line 3 col 4, and the next is at line 5 col 6, we subtract 3</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- from the 5 but leave the column alone since it's on a different line, resulting in [(3,4), (2,6)]</span><span>
</span><span id="line-246"></span><span class="hs-comment">--</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- If the first offset is at line 3 col 4, and the next is at line 3 col 6, we subtract 3 from</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- the line number AND subtract 4 from the column number since they're on the same line.</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- Resulting in [(3,4), (0,2)]</span><span>
</span><span id="line-250"></span><span class="hs-comment">--</span><span>
</span><span id="line-251"></span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- &gt;&gt;&gt; relativizeOffsets [(0, 0, Nothing), (0, 4, Just &quot;1&quot;), (0, 10, Nothing), (1, 0, Just &quot;2&quot;), (1, 5, Nothing), (5, 10, Just &quot;3&quot;)]</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- NOW [(0,0,Nothing),(0,4,Just &quot;1&quot;),(0,6,Nothing),(1,0,Just &quot;2&quot;),(0,5,Nothing),(4,10,Just &quot;3&quot;)]</span><span>
</span><span id="line-254"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#relativizeOffsets"><span class="hs-identifier hs-type">relativizeOffsets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span id="relativizeOffsets"><span class="annot"><span class="annottext">relativizeOffsets :: [(Int, Int, Maybe Text)] -&gt; [(Int, Int, Maybe Text)]
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#relativizeOffsets"><span class="hs-identifier hs-var hs-var">relativizeOffsets</span></a></span></span><span> </span><span id="local-6989586621680915535"><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915535"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680915534"><span class="annot"><span class="annottext">grouped :: [[(Int, Int, Maybe Text)]]
</span><a href="#local-6989586621680915534"><span class="hs-identifier hs-var hs-var">grouped</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [[a]]
</span><span class="hs-identifier hs-var">List.groupBy</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680915532"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915532"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915531"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915531"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915532"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915531"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915535"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-257"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[[(Int, Int, Maybe Text)]]
</span><a href="#local-6989586621680915534"><span class="hs-identifier hs-var">grouped</span></a></span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">List.mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680915529"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915529"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915528"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915528"><span class="hs-identifier hs-var">line</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915527"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915527"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915526"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915526"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915527"><span class="hs-identifier hs-var">col</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915528"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915527"><span class="hs-identifier hs-var">col</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915529"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915526"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">List.concat</span></span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><span class="hs-identifier hs-var">List.mapAccumL</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680915524"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915524"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915523"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915523"><span class="hs-identifier hs-var">line</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915522"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915522"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915521"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915521"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915523"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915523"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915524"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915522"><span class="hs-identifier hs-var">col</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915521"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- | Apply a list of range replacements to a list of lines, returning the result.</span><span>
</span><span id="line-263"></span><span class="hs-comment">--</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- &gt;&gt;&gt; applyTextReplacementsHelper [(0, 1, Nothing), (0, 4, Just &quot;1&quot;), (0, 2, Nothing), (1, 3, Just &quot;2&quot;), (0, 5, Nothing), (1, 10, Just &quot;3&quot;)] [&quot;abcdefghijk&quot;, &quot;lmnopqrstuv&quot;, &quot;wxyz&quot;, &quot;1234567890&quot;] &amp; TB.run</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- &quot;a1fg2opqrs3\n1234567890&quot;</span><span>
</span><span id="line-266"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-type">applyTextReplacementsHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TB.Builder</span></span><span>
</span><span id="line-267"></span><span id="applyTextReplacementsHelper"><span class="annot"><span class="annottext">applyTextReplacementsHelper :: [(Int, Int, Maybe Text)] -&gt; [Text] -&gt; Builder
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var hs-var">applyTextReplacementsHelper</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621680915520"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915520"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (foldable :: * -&gt; *).
Foldable foldable =&gt;
Builder -&gt; foldable Builder -&gt; Builder
</span><span class="hs-identifier hs-var">TB.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915520"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-269"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915516"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915516"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915515"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915515"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621680915514"><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915514"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915513"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915513"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621680915512"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915512"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915511"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915511"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915510"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915510"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text -&gt; (Text, Text)
</span><span class="hs-identifier hs-var">Text.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915516"><span class="hs-identifier hs-var">col</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915513"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-271"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915511"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915515"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)] -&gt; [Text] -&gt; Builder
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915514"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915510"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915512"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621680915507"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915507"><span class="hs-identifier hs-var">line</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915506"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915506"><span class="hs-identifier hs-var">col</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915505"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915505"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621680915504"><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915504"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680915503"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915503"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">List.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915507"><span class="hs-identifier hs-var">line</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915503"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680915501"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915501"><span class="hs-identifier hs-var">prefixLines</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (foldable :: * -&gt; *).
Foldable foldable =&gt;
Builder -&gt; foldable Builder -&gt; Builder
</span><span class="hs-identifier hs-var">TB.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915501"><span class="hs-identifier hs-var">prefixLines</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680915500"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915500"><span class="hs-identifier hs-var">prefixLines</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915499"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915499"><span class="hs-identifier hs-var">lastLine</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621680915498"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915498"><span class="hs-identifier hs-var">restLines</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680915497"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915497"><span class="hs-identifier hs-var">prefixChars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680915496"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915496"><span class="hs-identifier hs-var">suffixChars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text -&gt; (Text, Text)
</span><span class="hs-identifier hs-var">Text.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680915506"><span class="hs-identifier hs-var">col</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915499"><span class="hs-identifier hs-var">lastLine</span></a></span><span>
</span><span id="line-277"></span><span>          </span><span id="local-6989586621680915495"><span class="annot"><span class="annottext">segment :: Builder
</span><a href="#local-6989586621680915495"><span class="hs-identifier hs-var hs-var">segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (foldable :: * -&gt; *).
Foldable foldable =&gt;
Builder -&gt; foldable Builder -&gt; Builder
</span><span class="hs-identifier hs-var">TB.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915500"><span class="hs-identifier hs-var">prefixLines</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>              </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Builder
</span><span class="hs-identifier hs-var">TB.char</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span>
</span><span id="line-280"></span><span>              </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915497"><span class="hs-identifier hs-var">prefixChars</span></a></span><span>
</span><span id="line-281"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621680915495"><span class="hs-identifier hs-var">segment</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Builder
</span><span class="hs-identifier hs-var">TB.text</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680915505"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)] -&gt; [Text] -&gt; Builder
</span><a href="Unison.Codebase.Editor.HandleInput.FormatFile.html#applyTextReplacementsHelper"><span class="hs-identifier hs-var">applyTextReplacementsHelper</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, Int, Maybe Text)]
</span><a href="#local-6989586621680915504"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680915496"><span class="hs-identifier hs-var">suffixChars</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621680915498"><span class="hs-identifier hs-var">restLines</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span></pre></body></html>