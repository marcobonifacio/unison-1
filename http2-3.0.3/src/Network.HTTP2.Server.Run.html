<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP2.Server.Run</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forkIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">killThread</span></span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imports.html"><span class="hs-identifier">Imports</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.html"><span class="hs-identifier">Network.HTTP2.Arch</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.html"><span class="hs-identifier">Network.HTTP2.Frame</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Server.Types.html"><span class="hs-identifier">Network.HTTP2.Server.Types</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Server.Worker.html"><span class="hs-identifier">Network.HTTP2.Server.Worker</span></a></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">-- | Running HTTP/2 server.</span><span>
</span><span id="line-18"></span><span class="annot"><a href="Network.HTTP2.Server.Run.html#run"><span class="hs-identifier hs-type">run</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Server.Types.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span id="run"><span class="annot"><span class="annottext">run :: Config -&gt; Server -&gt; IO ()
</span><a href="Network.HTTP2.Server.Run.html#run"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679102813"><span class="annot"><span class="annottext">conf :: Config
</span><a href="#local-6989586621679102813"><span class="hs-identifier hs-var">conf</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679102806"><span id="local-6989586621679102807"><span id="local-6989586621679102808"><span id="local-6989586621679102809"><span id="local-6989586621679102810"><span id="local-6989586621679102811"><span class="annot"><span class="annottext">BufferSize
Buffer
Manager
BufferSize -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confTimeoutManager :: Config -&gt; Manager
confPositionReadMaker :: Config -&gt; PositionReadMaker
confReadN :: Config -&gt; BufferSize -&gt; IO ByteString
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confBufferSize :: Config -&gt; BufferSize
confWriteBuffer :: Config -&gt; Buffer
confTimeoutManager :: Manager
confPositionReadMaker :: PositionReadMaker
confReadN :: BufferSize -&gt; IO ByteString
confSendAll :: ByteString -&gt; IO ()
confBufferSize :: BufferSize
confWriteBuffer :: Buffer
</span><a href="Network.HTTP2.Arch.Config.html#confTimeoutManager"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679102799"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679102799"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-20"></span><span>    </span><span id="local-6989586621679102798"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679102798"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679102797"><span class="hs-identifier hs-var">checkPreface</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679102798"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-22"></span><span>        </span><span id="local-6989586621679102795"><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679102795"><span class="hs-identifier hs-var">serverInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO RoleInfo
</span><a href="Network.HTTP2.Arch.Context.html#newServerInfo"><span class="hs-identifier hs-var">newServerInfo</span></a></span><span>
</span><span id="line-23"></span><span>        </span><span id="local-6989586621679102793"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679102793"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RoleInfo -&gt; IO Context
</span><a href="Network.HTTP2.Arch.Context.html#newContext"><span class="hs-identifier hs-var">newContext</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679102795"><span class="hs-identifier hs-var">serverInfo</span></a></span><span>
</span><span id="line-24"></span><span>        </span><span class="hs-comment">-- Workers, worker manager and timer manager</span><span>
</span><span id="line-25"></span><span>        </span><span id="local-6989586621679102791"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Manager -&gt; IO Manager
</span><a href="Network.HTTP2.Arch.Manager.html#start"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102806"><span class="hs-identifier hs-var">confTimeoutManager</span></a></span><span>
</span><span id="line-26"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679102789"><span class="annot"><span class="annottext">wc :: WorkerConf Stream
</span><a href="#local-6989586621679102789"><span class="hs-identifier hs-var hs-var">wc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; WorkerConf Stream
</span><a href="Network.HTTP2.Server.Worker.html#fromContext"><span class="hs-identifier hs-var">fromContext</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679102793"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><span class="annottext">Manager -&gt; IO () -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Manager.html#setAction"><span class="hs-identifier hs-var">setAction</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. WorkerConf a -&gt; Manager -&gt; Server -&gt; IO ()
</span><a href="Network.HTTP2.Server.Worker.html#worker"><span class="hs-identifier hs-var">worker</span></a></span><span> </span><span class="annot"><span class="annottext">WorkerConf Stream
</span><a href="#local-6989586621679102789"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679102799"><span class="hs-identifier hs-var">server</span></a></span><span>
</span><span id="line-28"></span><span>        </span><span class="hs-comment">-- The number of workers is 3.</span><span>
</span><span id="line-29"></span><span>        </span><span class="hs-comment">-- This was carefully chosen based on a lot of benchmarks.</span><span>
</span><span id="line-30"></span><span>        </span><span class="hs-comment">-- If it is 1, we cannot avoid head-of-line blocking.</span><span>
</span><span id="line-31"></span><span>        </span><span class="hs-comment">-- If it is large, huge memory is consumed and many</span><span>
</span><span id="line-32"></span><span>        </span><span class="hs-comment">-- context switches happen.</span><span>
</span><span id="line-33"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; BufferSize -&gt; m a -&gt; m ()
</span><span class="hs-identifier hs-var">replicateM_</span></span><span> </span><span class="annot"><span class="annottext">BufferSize
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Manager -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Manager.html#spawnAction"><span class="hs-identifier hs-var">spawnAction</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-34"></span><span>        </span><span class="hs-comment">-- Receiver</span><span>
</span><span id="line-35"></span><span>        </span><span id="local-6989586621679102783"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679102783"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; (BufferSize -&gt; IO ByteString) -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#frameReceiver"><span class="hs-identifier hs-var">frameReceiver</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679102793"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">BufferSize -&gt; IO ByteString
</span><a href="#local-6989586621679102808"><span class="hs-identifier hs-var">confReadN</span></a></span><span>
</span><span id="line-36"></span><span>        </span><span class="hs-comment">-- Sender</span><span>
</span><span id="line-37"></span><span>        </span><span class="hs-comment">-- frameSender is the main thread because it ensures to send</span><span>
</span><span id="line-38"></span><span>        </span><span class="hs-comment">-- a goway frame.</span><span>
</span><span id="line-39"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Config -&gt; Manager -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Sender.html#frameSender"><span class="hs-identifier hs-var">frameSender</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679102793"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679102813"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. IO a -&gt; IO b -&gt; IO a
</span><span class="hs-operator hs-var">`E.finally`</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-40"></span><span>            </span><span class="annot"><span class="annottext">Manager -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Manager.html#stop"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621679102791"><span class="hs-identifier hs-var">mgr</span></a></span><span>
</span><span id="line-41"></span><span>            </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ()
</span><span class="hs-identifier hs-var">killThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679102783"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621679102797"><span class="annot"><span class="annottext">checkPreface :: IO Bool
</span><a href="#local-6989586621679102797"><span class="hs-identifier hs-var hs-var">checkPreface</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-44"></span><span>        </span><span id="local-6989586621679102770"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679102770"><span class="hs-identifier hs-var">preface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BufferSize -&gt; IO ByteString
</span><a href="#local-6989586621679102808"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">BufferSize
</span><a href="Network.HTTP2.Frame.html#connectionPrefaceLength"><span class="hs-identifier hs-var">connectionPrefaceLength</span></a></span><span>
</span><span id="line-45"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="Network.HTTP2.Frame.html#connectionPreface"><span class="hs-identifier hs-var">connectionPreface</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679102770"><span class="hs-identifier hs-var">preface</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-46"></span><span>            </span><span class="annot"><span class="annottext">Config -&gt; ErrorCodeId -&gt; ByteString -&gt; IO ()
</span><a href="Network.HTTP2.Server.Run.html#goaway"><span class="hs-identifier hs-var">goaway</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679102813"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Preface mismatch&quot;</span></span><span>
</span><span id="line-47"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-48"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-49"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- connClose must not be called here since Run:fork calls it</span><span>
</span><span id="line-52"></span><span class="annot"><a href="Network.HTTP2.Server.Run.html#goaway"><span class="hs-identifier hs-type">goaway</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#ErrorCodeId"><span class="hs-identifier hs-type">ErrorCodeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span id="goaway"><span class="annot"><span class="annottext">goaway :: Config -&gt; ErrorCodeId -&gt; ByteString -&gt; IO ()
</span><a href="Network.HTTP2.Server.Run.html#goaway"><span class="hs-identifier hs-var hs-var">goaway</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Config.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679102759"><span id="local-6989586621679102760"><span id="local-6989586621679102761"><span id="local-6989586621679102762"><span id="local-6989586621679102763"><span id="local-6989586621679102764"><span class="annot"><span class="annottext">BufferSize
Buffer
Manager
BufferSize -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confTimeoutManager :: Manager
confPositionReadMaker :: PositionReadMaker
confReadN :: BufferSize -&gt; IO ByteString
confSendAll :: ByteString -&gt; IO ()
confBufferSize :: BufferSize
confWriteBuffer :: Buffer
confTimeoutManager :: Config -&gt; Manager
confPositionReadMaker :: Config -&gt; PositionReadMaker
confReadN :: Config -&gt; BufferSize -&gt; IO ByteString
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confBufferSize :: Config -&gt; BufferSize
confWriteBuffer :: Config -&gt; Buffer
</span><a href="#local-6989586621679102759"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679102758"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679102758"><span class="hs-identifier hs-var">etype</span></a></span></span><span> </span><span id="local-6989586621679102757"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679102757"><span class="hs-identifier hs-var">debugmsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><a href="#local-6989586621679102762"><span class="hs-identifier hs-var">confSendAll</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679102756"><span class="hs-identifier hs-var">bytestream</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-55"></span><span>    </span><span id="local-6989586621679102756"><span class="annot"><span class="annottext">bytestream :: ByteString
</span><a href="#local-6989586621679102756"><span class="hs-identifier hs-var hs-var">bytestream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BufferSize -&gt; ErrorCodeId -&gt; ByteString -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#goawayFrame"><span class="hs-identifier hs-var">goawayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">BufferSize
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679102758"><span class="hs-identifier hs-var">etype</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679102757"><span class="hs-identifier hs-var">debugmsg</span></a></span><span>
</span><span id="line-56"></span></pre></body></html>