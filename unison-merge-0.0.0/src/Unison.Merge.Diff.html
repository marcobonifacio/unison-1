<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Merge.Diff</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier">nameBasedNamespaceDiff</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-4"></span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bitraverse</span></span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semialign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">alignWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">These</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DataDeclaration</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.HashQualified'</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HQ'</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Database.html"><span class="hs-identifier">Unison.Merge.Database</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Database.html#MergeDatabase"><span class="hs-identifier">MergeDatabase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.DeclNameLookup.html"><span class="hs-identifier">Unison.Merge.DeclNameLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DeclNameLookup.html#DeclNameLookup"><span class="hs-identifier">DeclNameLookup</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.DeclNameLookup.html"><span class="hs-identifier">Unison.Merge.DeclNameLookup</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DeclNameLookup</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html"><span class="hs-identifier">Unison.Merge.DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Synhash.html"><span class="hs-identifier">Unison.Merge.Synhash</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html"><span class="hs-identifier">Unison.Merge.Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier">Synhashed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.ThreeWay.html"><span class="hs-identifier">Unison.Merge.ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.ThreeWay.html#ThreeWay"><span class="hs-identifier">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.ThreeWay.html"><span class="hs-identifier">Unison.Merge.ThreeWay</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ThreeWay</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html"><span class="hs-identifier">Unison.Merge.TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html"><span class="hs-identifier">Unison.Merge.Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier">Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PrettyPrintEnv</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ppe</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Defns</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF3</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipDefnsWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- | @nameBasedNamespaceDiff db declNameLookups defns@ returns Alice's and Bob's name-based namespace diffs, each in the</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- form:</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- &gt; terms :: Map Name (DiffOp (Synhashed Referent))</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- &gt; types :: Map Name (DiffOp (Synhashed TypeReference))</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- where each name is paired with its diff-op (added, deleted, or updated), relative to the LCA between Alice and Bob's</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- branches. If the hash of a name did not change, it will not appear in the map.</span><span>
</span><span id="line-48"></span><span class="annot"><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier hs-type">nameBasedNamespaceDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Unison.Merge.Database.html#MergeDatabase"><span class="hs-identifier hs-type">MergeDatabase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.DeclNameLookup.html#DeclNameLookup"><span class="hs-identifier hs-type">DeclNameLookup</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Unison.Merge.ThreeWay.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span id="nameBasedNamespaceDiff"><span class="annot"><span class="annottext">nameBasedNamespaceDiff :: MergeDatabase
-&gt; TwoWay DeclNameLookup
-&gt; Map Name [Maybe Name]
-&gt; ThreeWay
     (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
-&gt; Transaction
     (TwoWay (DefnsF3 (Map Name) DiffOp Synhashed Referent Reference))
</span><a href="Unison.Merge.Diff.html#nameBasedNamespaceDiff"><span class="hs-identifier hs-var hs-var">nameBasedNamespaceDiff</span></a></span></span><span> </span><span id="local-6989586621679220794"><span class="annot"><span class="annottext">MergeDatabase
</span><a href="#local-6989586621679220794"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621679220793"><span class="annot"><span class="annottext">TwoWay DeclNameLookup
</span><a href="#local-6989586621679220793"><span class="hs-identifier hs-var">declNameLookups</span></a></span></span><span> </span><span id="local-6989586621679220792"><span class="annot"><span class="annottext">Map Name [Maybe Name]
</span><a href="#local-6989586621679220792"><span class="hs-identifier hs-var">lcaDeclToConstructors</span></a></span></span><span> </span><span id="local-6989586621679220791"><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>  </span><span id="local-6989586621679220790"><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent Reference
</span><a href="#local-6989586621679220790"><span class="hs-identifier hs-var">lcaHashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) term typ.
Monad m =&gt;
(term -&gt; m Hash)
-&gt; (Name -&gt; typ -&gt; m Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; m (DefnsF2 (Map Name) Synhashed term typ)
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var">synhashDefnsWith</span></a></span><span>
</span><span id="line-57"></span><span>      </span><span class="annot"><span class="annottext">Referent -&gt; Transaction Hash
</span><a href="#local-6989586621679220788"><span class="hs-identifier hs-var">hashTerm</span></a></span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679220787"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220787"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-59"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span id="local-6989586621679220785"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679220785"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashBuiltinDecl"><span class="hs-identifier hs-var">synhashBuiltinDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679220785"><span class="hs-identifier hs-var">builtin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621679220782"><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621679220782"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [Maybe Name]
</span><a href="#local-6989586621679220792"><span class="hs-identifier hs-var">lcaDeclToConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">Map.!</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220787"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-62"></span><span>              </span><span class="hs-comment">-- If we don't have a name for every constructor, that's okay, just use a dummy syntactic hash here.</span><span>
</span><span id="line-63"></span><span>              </span><span class="hs-comment">-- This is safe; Alice/Bob can't have such a decl (it violates a merge precondition), so there's no risk</span><span>
</span><span id="line-64"></span><span>              </span><span class="hs-comment">-- that we accidentally get an equal hash and classify a real update as unchanged.</span><span>
</span><span id="line-65"></span><span>              </span><span class="annot"><span class="annottext">Maybe [Name]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShortByteString -&gt; Hash
</span><span class="hs-identifier hs-var">Hash</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679220779"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679220779"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-67"></span><span>                </span><span id="local-6989586621679220778"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679220778"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; TypeReferenceId -&gt; Transaction (Decl Symbol Ann)
</span><a href="#local-6989586621679220777"><span class="hs-identifier hs-var">loadDeclWithGoodConstructorNames</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679220779"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621679220782"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-68"></span><span>                </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. Var v =&gt; PrettyPrintEnv -&gt; Name -&gt; Decl v a -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashDerivedDecl"><span class="hs-identifier hs-var">synhashDerivedDecl</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679220775"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220787"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679220778"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>      </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621679220774"><span class="annot"><span class="annottext">TwoWay (DefnsF2 (Map Name) Synhashed Referent Reference)
</span><a href="#local-6989586621679220774"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; Transaction (DefnsF2 (Map Name) Synhashed Referent Reference)
</span><a href="#local-6989586621679220773"><span class="hs-identifier hs-var">synhashDefns</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TwoWay DeclNameLookup
</span><a href="#local-6989586621679220793"><span class="hs-identifier hs-var">declNameLookups</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. ThreeWay a -&gt; TwoWay a
</span><a href="Unison.Merge.ThreeWay.html#forgetLca"><span class="hs-identifier hs-var">ThreeWay.forgetLca</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall term typ.
DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF3 (Map Name) DiffOp Synhashed term typ
</span><a href="Unison.Merge.Diff.html#diffNamespaceDefns"><span class="hs-identifier hs-var">diffNamespaceDefns</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF2 (Map Name) Synhashed Referent Reference
</span><a href="#local-6989586621679220790"><span class="hs-identifier hs-var">lcaHashes</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TwoWay (DefnsF2 (Map Name) Synhashed Referent Reference)
</span><a href="#local-6989586621679220774"><span class="hs-identifier hs-var">hashes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="#local-6989586621679220773"><span class="hs-identifier hs-type">synhashDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><a href="Unison.Merge.DeclNameLookup.html#DeclNameLookup"><span class="hs-identifier hs-type">DeclNameLookup</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621679220773"><span class="annot"><span class="annottext">synhashDefns :: DeclNameLookup
-&gt; Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; Transaction (DefnsF2 (Map Name) Synhashed Referent Reference)
</span><a href="#local-6989586621679220773"><span class="hs-identifier hs-var hs-var">synhashDefns</span></a></span></span><span> </span><span id="local-6989586621679220769"><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621679220769"><span class="hs-identifier hs-var">declNameLookup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-79"></span><span>      </span><span class="hs-comment">-- FIXME: use cache so we only synhash each thing once</span><span>
</span><span id="line-80"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) term typ.
Monad m =&gt;
(term -&gt; m Hash)
-&gt; (Name -&gt; typ -&gt; m Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; m (DefnsF2 (Map Name) Synhashed term typ)
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var">synhashDefnsWith</span></a></span><span> </span><span class="annot"><span class="annottext">Referent -&gt; Transaction Hash
</span><a href="#local-6989586621679220788"><span class="hs-identifier hs-var">hashTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Reference -&gt; Transaction Hash
</span><a href="#local-6989586621679220768"><span class="hs-identifier hs-var">hashType</span></a></span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><a href="#local-6989586621679220768"><span class="hs-identifier hs-type">hashType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-83"></span><span>        </span><span id="local-6989586621679220768"><span class="annot"><span class="annottext">hashType :: Name -&gt; Reference -&gt; Transaction Hash
</span><a href="#local-6989586621679220768"><span class="hs-identifier hs-var hs-var">hashType</span></a></span></span><span> </span><span id="local-6989586621679220767"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220767"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span id="local-6989586621679220766"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679220766"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashBuiltinDecl"><span class="hs-identifier hs-var">synhashBuiltinDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679220766"><span class="hs-identifier hs-var">builtin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621679220765"><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621679220765"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>            </span><span id="local-6989586621679220764"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679220764"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; TypeReferenceId -&gt; Transaction (Decl Symbol Ann)
</span><a href="#local-6989586621679220777"><span class="hs-identifier hs-var">loadDeclWithGoodConstructorNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; DeclNameLookup -&gt; Name -&gt; [Name]
</span><a href="Unison.Merge.DeclNameLookup.html#expectConstructorNames"><span class="hs-identifier hs-var">DeclNameLookup.expectConstructorNames</span></a></span><span> </span><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621679220769"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220767"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeReferenceId
</span><a href="#local-6989586621679220765"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-87"></span><span>            </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. Var v =&gt; PrettyPrintEnv -&gt; Name -&gt; Decl v a -&gt; Hash
</span><a href="Unison.Merge.Synhash.html#synhashDerivedDecl"><span class="hs-identifier hs-var">synhashDerivedDecl</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679220775"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220767"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621679220764"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="#local-6989586621679220777"><span class="hs-identifier hs-type">loadDeclWithGoodConstructorNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621679220777"><span class="annot"><span class="annottext">loadDeclWithGoodConstructorNames :: [Name] -&gt; TypeReferenceId -&gt; Transaction (Decl Symbol Ann)
</span><a href="#local-6989586621679220777"><span class="hs-identifier hs-var hs-var">loadDeclWithGoodConstructorNames</span></a></span></span><span> </span><span id="local-6989586621679220762"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679220762"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall v a. [v] -&gt; Decl v a -&gt; Decl v a
</span><span class="hs-identifier hs-var">DataDeclaration.setConstructorNames</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall v. Var v =&gt; Name -&gt; v
</span><span class="hs-identifier hs-var">Name.toVar</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679220762"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MergeDatabase
</span><a href="#local-6989586621679220794"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">loadV1Decl</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><a href="#local-6989586621679220788"><span class="hs-identifier hs-type">hashTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679220788"><span class="annot"><span class="annottext">hashTerm :: Referent -&gt; Transaction Hash
</span><a href="#local-6989586621679220788"><span class="hs-identifier hs-var hs-var">hashTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) v a.
(Monad m, Var v) =&gt;
(TypeReferenceId -&gt; m (Term v a))
-&gt; PrettyPrintEnv -&gt; Referent -&gt; m Hash
</span><a href="Unison.Merge.Synhash.html#synhashTerm"><span class="hs-identifier hs-var">synhashTerm</span></a></span><span> </span><span class="annot"><span class="annottext">MergeDatabase
</span><a href="#local-6989586621679220794"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">loadV1Term</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621679220775"><span class="hs-identifier hs-var">ppe</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="#local-6989586621679220775"><span class="hs-identifier hs-type">ppe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span>
</span><span id="line-98"></span><span>    </span><span id="local-6989586621679220775"><span class="annot"><span class="annottext">ppe :: PrettyPrintEnv
</span><a href="#local-6989586621679220775"><span class="hs-identifier hs-var hs-var">ppe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-comment">-- The order between Alice and Bob isn't important here for syntactic hashing; not sure right now if it matters</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-comment">-- that the LCA is added last</span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; PrettyPrintEnv
</span><a href="Unison.Merge.Diff.html#deepNamespaceDefinitionsToPpe"><span class="hs-identifier hs-var">deepNamespaceDefinitionsToPpe</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">alice</span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; PrettyPrintEnv -&gt; PrettyPrintEnv
</span><span class="hs-operator hs-var">`Ppe.addFallback`</span></span><span> </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; PrettyPrintEnv
</span><a href="Unison.Merge.Diff.html#deepNamespaceDefinitionsToPpe"><span class="hs-identifier hs-var">deepNamespaceDefinitionsToPpe</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">bob</span><span>
</span><span id="line-103"></span><span>        </span><span class="annot"><span class="annottext">PrettyPrintEnv -&gt; PrettyPrintEnv -&gt; PrettyPrintEnv
</span><span class="hs-operator hs-var">`Ppe.addFallback`</span></span><span> </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; PrettyPrintEnv
</span><a href="Unison.Merge.Diff.html#deepNamespaceDefinitionsToPpe"><span class="hs-identifier hs-var">deepNamespaceDefinitionsToPpe</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay
  (Defns (BiMultimap Referent Name) (BiMultimap Reference Name))
</span><a href="#local-6989586621679220791"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span id="local-6989586621679220932"><span id="local-6989586621679220933"><span class="annot"><a href="Unison.Merge.Diff.html#diffNamespaceDefns"><span class="hs-identifier hs-type">diffNamespaceDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220933"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220932"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220933"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220932"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220933"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220932"><span class="hs-identifier hs-type">typ</span></a></span></span></span><span>
</span><span id="line-109"></span><span id="diffNamespaceDefns"><span class="annot"><span class="annottext">diffNamespaceDefns :: forall term typ.
DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF2 (Map Name) Synhashed term typ
-&gt; DefnsF3 (Map Name) DiffOp Synhashed term typ
</span><a href="Unison.Merge.Diff.html#diffNamespaceDefns"><span class="hs-identifier hs-var hs-var">diffNamespaceDefns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="annottext">forall tm1 tm2 tm3 ty1 ty2 ty3.
(tm1 -&gt; tm2 -&gt; tm3)
-&gt; (ty1 -&gt; ty2 -&gt; ty3)
-&gt; Defns tm1 ty1
-&gt; Defns tm2 ty2
-&gt; Defns tm3 ty3
</span><span class="hs-identifier hs-var">zipDefnsWith</span></span><span> </span><span class="annot"><span class="annottext">forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref) -&gt; Map Name (DiffOp (Synhashed ref))
</span><a href="#local-6989586621679220755"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref) -&gt; Map Name (DiffOp (Synhashed ref))
</span><a href="#local-6989586621679220755"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-112"></span><span>    </span><span id="local-6989586621679220911"><span class="annot"><a href="#local-6989586621679220755"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220911"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220911"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220911"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621679220755"><span class="annot"><span class="annottext">f :: forall ref.
Map Name (Synhashed ref)
-&gt; Map Name (Synhashed ref) -&gt; Map Name (DiffOp (Synhashed ref))
</span><a href="#local-6989586621679220755"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679220750"><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679220750"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679220749"><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679220749"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="annottext">forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b c.
Semialign f =&gt;
(These a b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">alignWith</span></span><span> </span><span class="annot"><span class="annottext">forall x. Eq x =&gt; These x x -&gt; Maybe (DiffOp x)
</span><a href="#local-6989586621679220746"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679220750"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (Synhashed ref)
</span><a href="#local-6989586621679220749"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621679220897"><span class="annot"><a href="#local-6989586621679220746"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679220897"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="annot"><a href="#local-6989586621679220897"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220897"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220897"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621679220746"><span class="annot"><span class="annottext">g :: forall x. Eq x =&gt; These x x -&gt; Maybe (DiffOp x)
</span><a href="#local-6989586621679220746"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">This</span></span><span> </span><span id="local-6989586621679220742"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220742"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Delete"><span class="hs-identifier hs-var">DiffOp'Delete</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220742"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">That</span></span><span> </span><span id="local-6989586621679220739"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220739"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Add"><span class="hs-identifier hs-var">DiffOp'Add</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220739"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span id="local-6989586621679220736"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220736"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679220735"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220735"><span class="hs-identifier hs-var">new</span></a></span></span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220736"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679220735"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Updated a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Update"><span class="hs-identifier hs-var">DiffOp'Update</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">x
$sel:old:Updated :: x
old :: x
</span><a href="Unison.Merge.Updated.html#%24sel%3Aold%3AUpdated"><span class="hs-identifier hs-var hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">x
$sel:new:Updated :: x
new :: x
</span><a href="Unison.Merge.Updated.html#%24sel%3Anew%3AUpdated"><span class="hs-identifier hs-var hs-var">new</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- Pretty-print env helpers</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="annot"><a href="Unison.Merge.Diff.html#deepNamespaceDefinitionsToPpe"><span class="hs-identifier hs-type">deepNamespaceDefinitionsToPpe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnv</span></span><span>
</span><span id="line-128"></span><span id="deepNamespaceDefinitionsToPpe"><span class="annot"><span class="annottext">deepNamespaceDefinitionsToPpe :: Defns (BiMultimap Referent Name) (BiMultimap Reference Name)
-&gt; PrettyPrintEnv
</span><a href="Unison.Merge.Diff.html#deepNamespaceDefinitionsToPpe"><span class="hs-identifier hs-var hs-var">deepNamespaceDefinitionsToPpe</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679220729"><span class="annot"><span class="annottext">BiMultimap Referent Name
$sel:terms:Defns :: forall terms types. Defns terms types -&gt; terms
terms :: BiMultimap Referent Name
</span><span class="hs-identifier hs-var hs-var">terms</span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679220727"><span class="annot"><span class="annottext">BiMultimap Reference Name
$sel:types:Defns :: forall terms types. Defns terms types -&gt; types
types :: BiMultimap Reference Name
</span><span class="hs-identifier hs-var hs-var">types</span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="annottext">(Referent -&gt; [(HashQualified Name, HashQualified Name)])
-&gt; (Reference -&gt; [(HashQualified Name, HashQualified Name)])
-&gt; PrettyPrintEnv
</span><span class="hs-identifier hs-var">PrettyPrintEnv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall ref.
Ord ref =&gt;
BiMultimap ref Name
-&gt; ref -&gt; [(HashQualified Name, HashQualified Name)]
</span><a href="#local-6989586621679220724"><span class="hs-identifier hs-var">arbitraryName</span></a></span><span> </span><span class="annot"><span class="annottext">BiMultimap Referent Name
</span><a href="#local-6989586621679220729"><span class="hs-identifier hs-var">terms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall ref.
Ord ref =&gt;
BiMultimap ref Name
-&gt; ref -&gt; [(HashQualified Name, HashQualified Name)]
</span><a href="#local-6989586621679220724"><span class="hs-identifier hs-var">arbitraryName</span></a></span><span> </span><span class="annot"><span class="annottext">BiMultimap Reference Name
</span><a href="#local-6989586621679220727"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621679220886"><span class="annot"><a href="#local-6989586621679220724"><span class="hs-identifier hs-type">arbitraryName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679220886"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679220886"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679220886"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HQ'.HashQualified</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HQ'.HashQualified</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679220724"><span class="annot"><span class="annottext">arbitraryName :: forall ref.
Ord ref =&gt;
BiMultimap ref Name
-&gt; ref -&gt; [(HashQualified Name, HashQualified Name)]
</span><a href="#local-6989586621679220724"><span class="hs-identifier hs-var hs-var">arbitraryName</span></a></span></span><span> </span><span id="local-6989586621679220721"><span class="annot"><span class="annottext">BiMultimap ref Name
</span><a href="#local-6989586621679220721"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621679220720"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679220720"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>      </span><span class="annot"><span class="annottext">forall a b. Ord a =&gt; a -&gt; BiMultimap a b -&gt; Set b
</span><span class="hs-identifier hs-var">BiMultimap.lookupDom</span></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621679220720"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">BiMultimap ref Name
</span><a href="#local-6989586621679220721"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Set a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Set.lookupMin</span></span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679220715"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220715"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. n -&gt; HashQualified n
</span><span class="hs-identifier hs-var">HQ'.NameOnly</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220715"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. n -&gt; HashQualified n
</span><span class="hs-identifier hs-var">HQ'.NameOnly</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220715"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- Syntactic hashing helpers</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span id="local-6989586621679220951"><span id="local-6989586621679220952"><span id="local-6989586621679220953"><span class="annot"><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-type">synhashDefnsWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679220953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679220952"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679220953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679220951"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679220953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679220952"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679220951"><span class="hs-identifier hs-type">typ</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><a href="#local-6989586621679220953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DefnsF2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-type">Synhashed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220952"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679220951"><span class="hs-identifier hs-type">typ</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-146"></span><span id="synhashDefnsWith"><span class="annot"><span class="annottext">synhashDefnsWith :: forall (m :: * -&gt; *) term typ.
Monad m =&gt;
(term -&gt; m Hash)
-&gt; (Name -&gt; typ -&gt; m Hash)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
-&gt; m (DefnsF2 (Map Name) Synhashed term typ)
</span><a href="Unison.Merge.Diff.html#synhashDefnsWith"><span class="hs-identifier hs-var hs-var">synhashDefnsWith</span></a></span></span><span> </span><span id="local-6989586621679220699"><span class="annot"><span class="annottext">term -&gt; m Hash
</span><a href="#local-6989586621679220699"><span class="hs-identifier hs-var">hashTerm</span></a></span></span><span> </span><span id="local-6989586621679220698"><span class="annot"><span class="annottext">Name -&gt; typ -&gt; m Hash
</span><a href="#local-6989586621679220698"><span class="hs-identifier hs-var">hashType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">term -&gt; m (Synhashed term)
</span><a href="#local-6989586621679220696"><span class="hs-identifier hs-var">hashTerm1</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. BiMultimap a b -&gt; Map b a
</span><span class="hs-identifier hs-var">BiMultimap.range</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) k a b.
Applicative t =&gt;
(k -&gt; a -&gt; t b) -&gt; Map k a -&gt; t (Map k b)
</span><span class="hs-identifier hs-var">Map.traverseWithKey</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; typ -&gt; m (Synhashed typ)
</span><a href="#local-6989586621679220693"><span class="hs-identifier hs-var">hashType1</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. BiMultimap a b -&gt; Map b a
</span><span class="hs-identifier hs-var">BiMultimap.range</span></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679220696"><span class="annot"><span class="annottext">hashTerm1 :: term -&gt; m (Synhashed term)
</span><a href="#local-6989586621679220696"><span class="hs-identifier hs-var hs-var">hashTerm1</span></a></span></span><span> </span><span id="local-6989586621679220692"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679220692"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>      </span><span id="local-6989586621679220691"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679220691"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">term -&gt; m Hash
</span><a href="#local-6989586621679220699"><span class="hs-identifier hs-var">hashTerm</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679220692"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hash -&gt; a -&gt; Synhashed a
</span><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-var">Synhashed</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679220691"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621679220692"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621679220693"><span class="annot"><span class="annottext">hashType1 :: Name -&gt; typ -&gt; m (Synhashed typ)
</span><a href="#local-6989586621679220693"><span class="hs-identifier hs-var hs-var">hashType1</span></a></span></span><span> </span><span id="local-6989586621679220689"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220689"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679220688"><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679220688"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>      </span><span id="local-6989586621679220687"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679220687"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; typ -&gt; m Hash
</span><a href="#local-6989586621679220698"><span class="hs-identifier hs-var">hashType</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679220689"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679220688"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hash -&gt; a -&gt; Synhashed a
</span><a href="Unison.Merge.Synhashed.html#Synhashed"><span class="hs-identifier hs-var">Synhashed</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679220687"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">typ
</span><a href="#local-6989586621679220688"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span></pre></body></html>